<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Play Simulator</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- NETWORK DEPENDENCIES -->
    <script src="config.js?v=debug3"></script>
    <script src="js/paho-mqtt-min.js?v=debug3"></script>
    <script src="js/shared.js?v=debug4"></script>
    <script src="js/sequencer.js"></script>
    <style>
        body {
            background-color: #111;
            color: #eee;
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-shadow: 0 0 10px #fff;
            margin-bottom: 20px;
        }

        #stage {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            width: 100%;
            max-width: 1000px;
        }

        .box-container {
            flex: 1;
            background: #222;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transition: border-color 0.2s;
        }

        .box-container.active {
            border-color: #fff;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            background: #2a2a2a;
        }

        .box-title {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 5px;
        }

        .box-char {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .led-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            width: 100%;
        }

        .led {
            width: 12px;
            height: 12px;
            background-color: #111;
            border-radius: 50%;
            box-shadow: inset 0 0 2px #000;
            transition: background-color 0.05s, box-shadow 0.05s;
        }

        #controls {
            margin-top: 30px;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 30px;
            font-family: inherit;
            font-size: 16px;
            cursor: pointer;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 5px;
        }

        button:hover {
            background: #444;
        }

        button.primary {
            background: #2fab34;
            border-color: #2fab34;
            color: #000;
            font-weight: bold;
        }

        #log {
            margin-top: 20px;
            width: 80%;
            height: 150px;
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            overflow-y: auto;
            font-size: 12px;
            color: #0f0;
        }
    </style>
</head>

<body>

    <h1>Radio Play Simulator & Director</h1>

    <div id="controls">
        <button class="primary" onclick="startPlay()">PLAY ORIGINAL</button>
        <button class="primary" style="background:#d32f2f; border-color:#d32f2f" onclick="startFinale()">PLAY
            FINALE</button>
        <button onclick="stopPlay()">STOP</button>
    </div>

    <div id="stage">
        <!-- BOX 1: SAM / TINK -->
        <div class="box-container" id="box-tink">
            <div class="box-title">BOX 1 (Left)</div>
            <div class="box-char">"TINK"</div>
            <div class="led-grid" id="leds-tink"></div>
        </div>

        <!-- BOX 2: KRISTINE / BRAM -->
        <div class="box-container" id="box-bram">
            <div class="box-title">BOX 2 (Center)</div>
            <div class="box-char">"BRAM"</div>
            <div class="led-grid" id="leds-bram"></div>
        </div>

        <!-- BOX 3: JACOB / PIP -->
        <div class="box-container" id="box-pip">
            <div class="box-title">BOX 3 (Right)</div>
            <div class="box-char">"PIP"</div>
            <div class="led-grid" id="leds-pip"></div>
        </div>
    </div>

    <div id="log"></div>

    <script>
        // --- CONFIG ---
        // We moved audio to "www/audio", so relative path "audio/" should work for index.html in "www/"
        // BUT simulator.html is in "www/", so "audio/" refers to "www/audio/". This is correct.

        const LEDS_PER_BOX = 60;

        const SCRIPT = [
            // Round 1
            { char: 'pip', file: 'Pip 1.mp3' },
            { char: 'bram', file: 'Bram 1.mp3' },
            { char: 'tink', file: 'Tink 1.mp3' },
            // Round 2
            { char: 'pip', file: 'Pip 2.mp3' },
            { char: 'bram', file: 'Bram 2.mp3' },
            { char: 'tink', file: 'Tink 2.mp3' },
            // Round 3
            { char: 'pip', file: 'Pip 3.mp3' },
            { char: 'bram', file: 'Bram 3.mp3' },
            { char: 'tink', file: 'Tink 3.mp3' },
            // Round 4
            { char: 'pip', file: 'Pip 4.mp3' },
            { char: 'bram', file: 'Bram 4.mp3' },
            { char: 'tink', file: 'Tink 4.mp3' },
            // Round 5
            { char: 'pip', file: 'Pip 5.mp3' },
            { char: 'bram', file: 'Bram 5.mp3' },
            { char: 'tink', file: 'Tink 5.mp3' },
            // Round 6 (Bram out)
            { char: 'pip', file: 'Pip 6.mp3' },
            { char: 'tink', file: 'Tink 6.mp3' },
        ];

        // --- SETUP ---
        const seq = new ScriptSequencer();

        // INIT NETWORK
        if (window.Network) {
            console.log("Initializing Director Network...");
            Network.init();
        }

        const BOX_MAP = {
            'tink': 'tink',
            'bram': 'bram',
            'pip': 'pip'
        };

        const ledElements = { tink: [], bram: [], pip: [] };

        ['tink', 'bram', 'pip'].forEach(id => {
            const container = document.getElementById(`leds-${id}`);
            for (let i = 0; i < LEDS_PER_BOX; i++) {
                const led = document.createElement('div');
                led.className = 'led';
                container.appendChild(led);
                ledElements[id].push(led);
            }
        });

        function log(msg) {
            const l = document.getElementById('log');
            l.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        // --- SEQUENCER HOOKS ---

        let activeBox = null;

        seq.on('onItemStart', (item) => {
            const boxId = BOX_MAP[item.character.toLowerCase()];
            log(`â–¶ï¸ START: ${item.character} (${item.file})`);

            document.querySelectorAll('.box-container').forEach(d => d.classList.remove('active'));
            const container = document.getElementById(`box-${boxId}`);
            if (container) container.classList.add('active');

            activeBox = boxId;

            // DIRECTOR MODE: Send MQTT Command
            if (window.Network && boxId) {
                // Assuming 'speaking' animation type 8 defined in firmware
                // We need to pass the simple 'name' that Network.sendAnim expects
                // But shared.js getBoxIndex searches by ID/Name. 
                // Let's pass the boxId ('tink'/'bram'/'pip') which hopefully maps to 'sam'/'kristine'/'jacob' via config or shared.js handling.
                // Wait, shared.js sendAnim uses getBoxIndex(name). 
                // Config.js likely has IDs: 'box_1_holiday' (Sam), 'box_2_holiday' (Kris), etc.
                // We need a mapping from Character -> Real Box Name for Network.js

                // TEMP MAPPING for Director:
                const CHAR_TO_REAL = {
                    'tink': 'sam',
                    'bram': 'kristine',
                    'pip': 'jacob'
                };
                const realName = CHAR_TO_REAL[item.character.toLowerCase()];
                if (realName) {
                    Network.sendAnim(realName, 'speaking', 'on');
                }
            }
        });

        seq.on('onItemEnd', (item) => {
            log(`â¹ï¸ END: ${item.character}`);
            activeBox = null;
            document.querySelectorAll('.box-container').forEach(d => d.classList.remove('active'));
            clearAllLeds();

            // DIRECTOR MODE: Stop MQTT Animation
            const CHAR_TO_REAL = {
                'tink': 'sam',
                'bram': 'kristine',
                'pip': 'jacob'
            };
            const realName = CHAR_TO_REAL[item.character.toLowerCase()];
            if (realName && window.Network) {
                Network.sendAnim(realName, 'speaking', 'off');
            }
        });

        seq.on('onComplete', () => {
            log("âœ… SHOW COMPLETE");
            activeBox = null;
            clearAllLeds();
        });

        // --- ANIMATION LOOP ---
        function animate() {
            if (activeBox) {
                const strip = ledElements[activeBox];
                if (strip) {
                    let amp = 0;

                    if (finaleInterval && finaleAnalyser) {
                        // Finale Mode
                        finaleAnalyser.getByteFrequencyData(finaleDataArray);
                        let sum = 0;
                        for (let i = 0; i < finaleDataArray.length; i++) {
                            sum += finaleDataArray[i];
                        }
                        amp = sum / finaleDataArray.length / 255;
                    } else {
                        // Original Mode
                        amp = seq.getAmplitude(); // 0.0 to 1.0 (approx)
                    }

                    const boostAmp = Math.min(1.0, amp * 5); // Boost signal
                    // console.log(boostAmp); // Debug

                    // Clear first
                    strip.forEach(l => {
                        l.style.backgroundColor = '#111';
                        l.style.boxShadow = 'none';
                    });

                    if (activeBox === 'tink') {
                        // BOX 1 (Tink): Random Flicker (Original)
                        const numActive = Math.floor(Math.random() * (strip.length / 2)) + 5;
                        for (let i = 0; i < numActive; i++) {
                            const idx = Math.floor(Math.random() * strip.length);
                            const r = 255;
                            const g = 180 + Math.floor(Math.random() * 50);
                            const b = 50 + Math.floor(Math.random() * 50);
                            const color = `rgb(${r},${g},${b})`;
                            strip[idx].style.backgroundColor = color;
                            strip[idx].style.boxShadow = `0 0 10px ${color}`;
                        }
                    } else if (activeBox === 'bram') {
                        // BOX 2 (Bram): Center Out
                        const center = Math.floor(strip.length / 2);
                        const width = Math.floor(boostAmp * (strip.length / 2));

                        const color = `rgb(0, 255, 255)`; // Cyan for Kristine/Bram? Or keep Gold?
                        // User didn't specify color, assuming Gold/White consistent? 
                        // Actually Kristine was Blue/Cyan in previous context. Let's keep Gold for "Vocal" consistency or make it distinct?
                        // "Standard" vocal color is Gold/White per previous convo. Sticking to Gold.
                        const r = 255; const g = 200; const b = 100;

                        for (let i = 0; i <= width; i++) {
                            // Left
                            if (center - i >= 0) setLed(strip[center - i], r, g, b);
                            // Right
                            if (center + i < strip.length) setLed(strip[center + i], r, g, b);
                        }
                    } else if (activeBox === 'pip') {
                        // BOX 3 (Pip): Bottom Up (Index 0 to N)
                        // Assuming 0 is bottom? Or N is bottom?
                        // In standard flex wrapping (L-R, T-B), index 0 is Top-Left. 
                        // So "Bottom Up" implies filling form Index N backwards?
                        const count = Math.floor(boostAmp * strip.length);
                        const r = 255; const g = 100; const b = 50; // Orange?

                        // Fill from end (bottom)
                        for (let i = 0; i < count; i++) {
                            setLed(strip[strip.length - 1 - i], r, g, b);
                        }
                    }
                }
            }
            requestAnimationFrame(animate);
        }

        function setLed(el, r, g, b) {
            if (!el) return;
            const color = `rgb(${r},${g},${b})`;
            el.style.backgroundColor = color;
            el.style.boxShadow = `0 0 10px ${color}`;
        }

        function clearAllLeds() {
            ['tink', 'bram', 'pip'].forEach(id => {
                ledElements[id].forEach(l => {
                    l.style.backgroundColor = '#111';
                    l.style.boxShadow = 'none';
                });
            });
        }

        animate();

        // --- CONTROLS ---

        function startPlay() {
            // Update to use relative path in 'audio/' folder
            /*
             - [x] Record/Generate audio files (split by line: `tink_01.mp3`, etc.).
             - [x] Upload audio assets to Web Server.
             - [ ] **Director Software (Web)**
             - [x] Create `ScriptSequencer` class.
             - [ ] Link `simulator.html` to MQTT (Director Mode).
             - [ ] Create Trigger Button in Admin.lative path in 'audio/' folder
            */
            // AND map 'char' to 'character' for sequencer
            const loadScript = SCRIPT.map(s => ({
                character: s.char,
                file: `audio/${s.file}`
            }));

            seq.loadScript(loadScript);
            seq.play();
        }

        function stopPlay() {
            seq.stop();
            if (finaleInterval) clearInterval(finaleInterval);
            ['sam', 'kris', 'jacob', 'tink', 'bram', 'pip'].forEach(id => {
                const audio = document.getElementById('aud-' + id);
                if (audio) { audio.pause(); audio.currentTime = 0; }
            });
            activeBox = null;
            clearAllLeds();
        }

        // --- FINALE LOGIC ---
        let finaleInterval = null;
        let finaleSequence = [];
        let finaleStartTime = 0;

        async function startFinale() {
            stopPlay();
            log("ðŸš€ LOADING FINALE...");

            // 1. Load Sequence
            try {
                const res = await fetch('show_sequence.json');
                finaleSequence = await res.json();
                finaleSequence.forEach(e => e.fired = false); // Reset
            } catch (e) {
                log("âŒ Error loading sequence: " + e.message);
                log("âš ï¸ MUST RUN ON LOCALHOST (Python server), NOT file://");
                return;
            }

            // 2. Prepare Audio
            const tracks = [
                { id: 'sam', src: 'audio/Finale_Sam.mp3' },
                { id: 'kris', src: 'audio/Finale_Kristine.mp3' },
                { id: 'jacob', src: 'audio/Finale_Jacob.mp3' }
            ];

            const promises = tracks.map(t => {
                let a = document.getElementById('aud-' + t.id);
                if (!a) {
                    a = document.createElement('audio');
                    a.id = 'aud-' + t.id;
                    a.src = t.src;
                    document.body.appendChild(a);
                }
                a.currentTime = 0;
                // Add user interaction handling/logging
                return a.play().then(() => {
                    // log(`âœ… Playing ${t.id}`);
                }).catch(e => {
                    log(`âŒ Play Error (${t.id}): ${e.message}`);
                    console.error(e);
                });
            });

            // 3. Play
            await Promise.all(promises);
            log("â–¶ï¸ SHOW STARTED");

            finaleStartTime = Date.now();
            finaleInterval = setInterval(updateFinale, 50);
        }

        function createAudio(id, src) {
            const a = document.createElement('audio');
            a.id = 'aud-' + id;
            a.src = src;
            document.body.appendChild(a);
        }

        function updateFinale() {
            const elapsed = Date.now() - finaleStartTime;
            let allDone = true;

            finaleSequence.forEach(evt => {
                if (!evt.fired) {
                    allDone = false;
                    if (elapsed >= evt.time) {
                        evt.fired = true;

                        // Map 'box' (sam/kristine/jacob) to simulator IDs
                        // User: Box 1 = Kristine, Box 2 = Jacob, Box 3 = Sam
                        // Simulator: Box 1 = Tink, Box 2 = Bram, Box 3 = Pip
                        const MAP = { 'kristine': 'tink', 'jacob': 'bram', 'sam': 'pip' };
                        const simId = MAP[evt.box.toLowerCase()] || 'tink';

                        // Log
                        if (evt.state === 'on') {
                            log(`ðŸ’¡ ${evt.box.toUpperCase()} SPEAKING`);
                            activeBox = simId;

                            // Visuals
                            document.querySelectorAll('.box-container').forEach(d => d.classList.remove('active'));
                            document.getElementById(`box-${simId}`).classList.add('active');
                        } else {
                            // Only turn off if it matches current?
                            if (activeBox === simId) {
                                activeBox = null;
                                document.querySelectorAll('.box-container').forEach(d => d.classList.remove('active'));
                                clearAllLeds(); // Stop animation
                            }
                        }
                    }
                }
            });

            // Keep animating via the main loop 'animate()' which checks 'activeBox'

            if (allDone && elapsed > 105000) {
                log("âœ… FINALE COMPLETE");
                stopPlay();
            }
        }

    </script>
</body>

</html>